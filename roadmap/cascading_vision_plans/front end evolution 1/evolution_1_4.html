<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plan and Traction Cascade</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../../resultmaps-web/public/stylesheets/b3single_packaged.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @font-face {
      font-family: 'Font Awesome 5 Pro';
      font-style: normal;
      font-weight: 300;
      src: url('../../../resultmaps-web/public/assets/webfonts/fa-light-300.woff2') format('woff2'),
           url('../../../resultmaps-web/public/assets/webfonts/fa-light-300.woff') format('woff');
    }

    .fal {
      display: inline-block;
      font-family: 'Font Awesome 5 Pro';
      font-weight: 300;
      font-style: normal;
      line-height: 1;
    }

    .fal.fa-chevron-right::before { content: "\f054"; }
    .fal.fa-chevron-down::before { content: "\f078"; }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: #f9f9f9;
      color: #555;
      padding: 2rem;
      min-height: 100vh;
      overflow: auto;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 2rem;
      color: #3D2177;
    }

    #tree-svg {
      display: block;
    }

    .link {
      fill: none;
      stroke: #E8E9EC;
      stroke-width: 2;
    }

    .node-name {
      font-weight: 600;
      font-size: 14px;
      fill: #3D2177;
    }

    .section-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      fill: #6A45B7;
      font-weight: 500;
    }

    .metric-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      fill: #8C74BF;
    }

    .metric-value {
      font-size: 13px;
      font-weight: 600;
      fill: #3D2177;
    }

    .ten-year-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      fill: rgb(0, 173, 239);
    }

    .ten-year-value {
      font-size: 15px;
      font-weight: 600;
      fill: #3D2177;
    }

    .measurables-label {
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      fill: #8C74BF;
    }

    .measurables-text {
      font-size: 10px;
      fill: #555;
    }

    .look-like-label {
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      fill: #8C74BF;
    }

    .look-like-item {
      font-size: 10px;
      fill: #555;
    }

    .header-line {
      stroke: #E8E9EC;
      stroke-width: 1;
    }

    .metric-bg {
      fill: #f9f9f9;
    }

    .goal-title {
      font-weight: 600;
      font-size: 12px;
      fill: #3D2177;
    }

    .goal-text {
      font-size: 10px;
      fill: #555;
    }

    .rock-title {
      font-weight: 500;
      font-size: 11px;
      fill: #3D2177;
    }

    .rock-text {
      font-size: 9px;
      fill: #555;
    }

    .clickable {
      cursor: pointer;
    }

    .clickable:hover rect:first-child {
      filter: url(#shadowHover);
    }

    .badge-text {
      font-size: 9px;
      font-weight: 500;
    }

    .status-pill-text {
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .scorecard-header {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      fill: #6A45B7;
      font-weight: 500;
    }

    .scorecard-name {
      font-size: 11px;
      fill: #3D2177;
    }

    .scorecard-value {
      font-size: 11px;
      fill: #3D2177;
      font-weight: 500;
    }

    .scorecard-row-bg {
      fill: #f9f9f9;
    }

    .scorecard-row-bg-alt {
      fill: #ffffff;
    }

    .on-track {
      fill: #468847;
    }

    .off-track {
      fill: #B00020;
    }
  </style>
</head>
<body>
  <h1>Plan and Traction Cascade</h1>
  <div id="tree-container"></div>

  <script>
    const visionData = {
      "id": "example-air",
      "name": "Example Air Systems",
      "level": "corporate",
      "vto": {
        "tenYearTarget": "$7.0B in Revenue",
        "threeYearPicture": {
          "futureDate": "2029-12-31",
          "revenue": "$2.6B",
          "profit": "$182M",
          "measurables": "Sales Bookings, Gross Margin, Backlog",
          "whatDoesItLookLike": [
            "5 offices operating on unified EOS system",
            "Industry leader in Texas HVAC market",
            "Data Center division established in all major metros",
            "Turnkey capabilities in every office",
            "85% PM Utilization Rate company-wide"
          ]
        },
        "oneYearPlan": {
          "futureDate": "2026-12-31",
          "revenue": "$1.72B",
          "profit": "$112M",
          "measurables": "Sales Bookings, Gross Margin"
        }
      },
      "scorecard": [
        { "name": "Revenue", "unit": "$", "target": 1720000000, "current": 1650000000, "onTrack": false },
        { "name": "Profit", "unit": "$", "target": 112000000, "current": 118000000, "onTrack": true },
        { "name": "Sales Bookings", "unit": "$", "target": 2000000000, "current": 1950000000, "onTrack": false },
        { "name": "Gross Margin", "unit": "$", "target": 450000000, "current": 460000000, "onTrack": true },
        { "name": "Backlog", "unit": "$", "target": 800000000, "current": 820000000, "onTrack": true },
        { "name": "Data Center Bookings", "unit": "$", "target": 500000000, "current": 480000000, "onTrack": false },
        { "name": "Hydronics Bookings", "unit": "$", "target": 100000000, "current": 105000000, "onTrack": true },
        { "name": "Turnkey", "unit": "$", "target": 200000000, "current": 210000000, "onTrack": true }
      ],
      "children": [
        {
          "id": "dfw",
          "name": "DFW",
          "level": "office",
          "vto": {
            "threeYearPicture": { "revenue": "$1.18B", "profit": "$83M", "measurables": "Sales Bookings, Gross Margin, Backlog", "whatDoesItLookLike": ["Largest office in Example Air", "Data Center team fully operational", "Turnkey division established", "Strong succession pipeline"] },
            "oneYearPlan": { "revenue": "$776M", "profit": "$54M", "measurables": "Sales Bookings, Gross Margin, Data Center Bookings, Turnkey" }
          },
          "scorecard": [
            { "name": "Revenue", "unit": "$", "target": 776000000, "current": 750000000, "onTrack": false },
            { "name": "Profit", "unit": "$", "target": 54000000, "current": 56000000, "onTrack": true },
            { "name": "Sales Bookings", "unit": "$", "target": 900000000, "current": 880000000, "onTrack": false },
            { "name": "Gross Margin", "unit": "$", "target": 200000000, "current": 205000000, "onTrack": true },
            { "name": "Backlog", "unit": "$", "target": 350000000, "current": 360000000, "onTrack": true },
            { "name": "Data Center Bookings", "unit": "$", "target": 250000000, "current": 240000000, "onTrack": false },
            { "name": "Hydronics Bookings", "unit": "$", "target": 40000000, "current": 42000000, "onTrack": true },
            { "name": "Turnkey", "unit": "$", "target": 80000000, "current": 85000000, "onTrack": true }
          ],
          "_children": [
            {
              "id": "dfw-goal-0",
              "name": "Achieve $900M in sales bookings",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "dfw-rock-0-0", "name": "Book $250M in Data Center projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "dfw-rock-0-1", "name": "Book $80M in Turnkey projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "dfw-rock-0-2", "name": "Grow Hydronics to $40M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "dfw-goal-1",
              "name": "Deliver $54M profit at 25% gross margin",
              "level": "goal",
          "status": "off",
              "text": "",
              "_children": [
                { "id": "dfw-rock-1-0", "name": "Increase PM utilization to 87%", "level": "rock",
          "status": "off", "text": "" },
                { "id": "dfw-rock-1-1", "name": "Maintain 25% gross margin", "level": "rock",
          "status": "on", "text": "" },
                { "id": "dfw-rock-1-2", "name": "Build backlog to $350M", "level": "rock",
          "status": "off", "text": "" }
              ],
              "children": null
            },
            {
              "id": "dfw-goal-2",
              "name": "Build Data Center team capacity",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "dfw-rock-2-0", "name": "Hire Data Center sales lead", "level": "rock",
          "status": "on", "text": "" },
                { "id": "dfw-rock-2-1", "name": "Add 2 Data Center project managers", "level": "rock",
          "status": "on", "text": "" },
                { "id": "dfw-rock-2-2", "name": "Complete succession plan for senior PMs", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            }
          ],
          "children": null
        },
        {
          "id": "houston",
          "name": "Houston",
          "level": "office",
          "vto": {
            "threeYearPicture": { "revenue": "$787M", "profit": "$55M", "measurables": "Sales Bookings, Gross Margin, Backlog", "whatDoesItLookLike": ["Data Center team with dedicated leader", "Industrial Turnkey capabilities", "Service business at $50M", "Strong account management"] },
            "oneYearPlan": { "revenue": "$518M", "profit": "$34M", "measurables": "Sales Bookings, Gross Margin, Data Center Bookings, Turnkey" }
          },
          "scorecard": [
            { "name": "Revenue", "unit": "$", "target": 518000000, "current": 500000000, "onTrack": false },
            { "name": "Profit", "unit": "$", "target": 34000000, "current": 35000000, "onTrack": true },
            { "name": "Sales Bookings", "unit": "$", "target": 600000000, "current": 580000000, "onTrack": false },
            { "name": "Gross Margin", "unit": "$", "target": 130000000, "current": 135000000, "onTrack": true },
            { "name": "Backlog", "unit": "$", "target": 250000000, "current": 260000000, "onTrack": true },
            { "name": "Data Center Bookings", "unit": "$", "target": 150000000, "current": 145000000, "onTrack": false },
            { "name": "Hydronics Bookings", "unit": "$", "target": 30000000, "current": 32000000, "onTrack": true },
            { "name": "Turnkey", "unit": "$", "target": 60000000, "current": 62000000, "onTrack": true }
          ],
          "_children": [
            {
              "id": "houston-goal-0",
              "name": "Achieve $600M in sales bookings",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "houston-rock-0-0", "name": "Book $150M in Data Center projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-0-1", "name": "Book $60M in Industrial Turnkey", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-0-2", "name": "Grow Hydronics to $30M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "houston-goal-1",
              "name": "Deliver $34M profit at 25% gross margin",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "houston-rock-1-0", "name": "Increase PM utilization to 85%", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-1-1", "name": "Maintain 25% gross margin", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-1-2", "name": "Build backlog to $250M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "houston-goal-2",
              "name": "Establish Industrial Turnkey division",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "houston-rock-2-0", "name": "Hire Turnkey division leader", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-2-1", "name": "Close 3 industrial turnkey projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "houston-rock-2-2", "name": "Build service business to $15M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            }
          ],
          "children": null
        },
        {
          "id": "austin",
          "name": "Austin",
          "level": "office",
          "vto": {
            "threeYearPicture": { "revenue": "$371M", "profit": "$26M", "measurables": "Sales Bookings, Gross Margin, Backlog", "whatDoesItLookLike": ["Data Center leader in Central Texas", "Turnkey at $40M", "Controls business established", "AD Business operational"] },
            "oneYearPlan": { "revenue": "$244M", "profit": "$16M", "measurables": "Sales Bookings, Gross Margin, Backlog" }
          },
          "scorecard": [
            { "name": "Revenue", "unit": "$", "target": 244000000, "current": 240000000, "onTrack": false },
            { "name": "Profit", "unit": "$", "target": 16000000, "current": 16500000, "onTrack": true },
            { "name": "Sales Bookings", "unit": "$", "target": 280000000, "current": 275000000, "onTrack": false },
            { "name": "Gross Margin", "unit": "$", "target": 60000000, "current": 62000000, "onTrack": true },
            { "name": "Backlog", "unit": "$", "target": 160000000, "current": 165000000, "onTrack": true },
            { "name": "Data Center Bookings", "unit": "$", "target": 100000000, "current": 95000000, "onTrack": false },
            { "name": "Hydronics Bookings", "unit": "$", "target": 15000000, "current": 16000000, "onTrack": true },
            { "name": "Turnkey", "unit": "$", "target": 30000000, "current": 32000000, "onTrack": true }
          ],
          "_children": [
            {
              "id": "austin-goal-0",
              "name": "Achieve $280M in sales bookings",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "austin-rock-0-0", "name": "Book $100M in Data Center projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-0-1", "name": "Book $30M in Turnkey projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-0-2", "name": "Book $5M in Controls", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "austin-goal-1",
              "name": "Deliver $15.8M Net Income at 24.5% Gross Margin",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "austin-rock-1-0", "name": "Increase PM utilization to 85%", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-1-1", "name": "Maintain 24.5% gross margin", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-1-2", "name": "Establish backlog of $160M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "austin-goal-2",
              "name": "Build team capacity to support growth",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "austin-rock-2-0", "name": "Hire 4 outside sales members", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-2-1", "name": "Establish Data Center team with leader", "level": "rock",
          "status": "on", "text": "" },
                { "id": "austin-rock-2-2", "name": "Complete succession plan for KK & JJ", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            }
          ],
          "children": null
        },
        {
          "id": "san-antonio",
          "name": "San Antonio",
          "level": "office",
          "vto": {
            "threeYearPicture": { "revenue": "$140M", "profit": "$9M", "measurables": "Sales Bookings, Gross Margin, Backlog", "whatDoesItLookLike": ["RGV market fully developed", "Hydronics leadership in region", "Middle Market established", "Service at $10M"] },
            "oneYearPlan": { "revenue": "$92M", "profit": "$6M", "measurables": "Sales Bookings, Gross Margin, Hydronics Bookings, Turnkey" }
          },
          "scorecard": [
            { "name": "Revenue", "unit": "$", "target": 92000000, "current": 90000000, "onTrack": false },
            { "name": "Profit", "unit": "$", "target": 6000000, "current": 6200000, "onTrack": true },
            { "name": "Sales Bookings", "unit": "$", "target": 110000000, "current": 105000000, "onTrack": false },
            { "name": "Gross Margin", "unit": "$", "target": 23000000, "current": 24000000, "onTrack": true },
            { "name": "Backlog", "unit": "$", "target": 50000000, "current": 52000000, "onTrack": true },
            { "name": "Data Center Bookings", "unit": "$", "target": 20000000, "current": 18000000, "onTrack": false },
            { "name": "Hydronics Bookings", "unit": "$", "target": 15000000, "current": 16000000, "onTrack": true },
            { "name": "Turnkey", "unit": "$", "target": 20000000, "current": 21000000, "onTrack": true }
          ],
          "_children": [
            {
              "id": "san-antonio-goal-0",
              "name": "Achieve $110M in sales bookings",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "san-antonio-rock-0-0", "name": "Book $20M in Data Center projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-0-1", "name": "Book $20M in Turnkey projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-0-2", "name": "Grow Hydronics to $15M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "san-antonio-goal-1",
              "name": "Deliver $6M profit at 25% gross margin",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "san-antonio-rock-1-0", "name": "Increase PM utilization to 82%", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-1-1", "name": "Maintain 25% gross margin", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-1-2", "name": "Build backlog to $50M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "san-antonio-goal-2",
              "name": "Develop RGV market presence",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "san-antonio-rock-2-0", "name": "Hire RGV sales representative", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-2-1", "name": "Close 5 RGV projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "san-antonio-rock-2-2", "name": "Establish Hydronics leadership", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            }
          ],
          "children": null
        },
        {
          "id": "west-texas",
          "name": "West Texas",
          "level": "office",
          "vto": {
            "threeYearPicture": { "revenue": "$130M", "profit": "$8M", "measurables": "Sales Bookings, Gross Margin, Backlog", "whatDoesItLookLike": ["Core equipment business strong", "Hydronics presence established", "Service team built out"] },
            "oneYearPlan": { "revenue": "$90M", "profit": "$6M", "measurables": "Sales Bookings, Gross Margin, Hydronics Bookings, Turnkey" }
          },
          "scorecard": [
            { "name": "Revenue", "unit": "$", "target": 90000000, "current": 88000000, "onTrack": false },
            { "name": "Profit", "unit": "$", "target": 6000000, "current": 6100000, "onTrack": true },
            { "name": "Sales Bookings", "unit": "$", "target": 100000000, "current": 95000000, "onTrack": false },
            { "name": "Gross Margin", "unit": "$", "target": 22000000, "current": 23000000, "onTrack": true },
            { "name": "Backlog", "unit": "$", "target": 45000000, "current": 47000000, "onTrack": true },
            { "name": "Data Center Bookings", "unit": "$", "target": 15000000, "current": 14000000, "onTrack": false },
            { "name": "Hydronics Bookings", "unit": "$", "target": 12000000, "current": 13000000, "onTrack": true },
            { "name": "Turnkey", "unit": "$", "target": 18000000, "current": 19000000, "onTrack": true }
          ],
          "_children": [
            {
              "id": "west-texas-goal-0",
              "name": "Achieve $100M in sales bookings",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "west-texas-rock-0-0", "name": "Book $15M in Data Center projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-0-1", "name": "Book $18M in Turnkey projects", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-0-2", "name": "Grow Hydronics to $12M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "west-texas-goal-1",
              "name": "Deliver $6M profit at 24% gross margin",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "west-texas-rock-1-0", "name": "Increase PM utilization to 80%", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-1-1", "name": "Maintain 24% gross margin", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-1-2", "name": "Build backlog to $45M", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            },
            {
              "id": "west-texas-goal-2",
              "name": "Build service team capability",
              "level": "goal",
          "status": "on",
              "text": "",
              "_children": [
                { "id": "west-texas-rock-2-0", "name": "Hire 2 service technicians", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-2-1", "name": "Establish Hydronics presence", "level": "rock",
          "status": "on", "text": "" },
                { "id": "west-texas-rock-2-2", "name": "Grow core equipment business 10%", "level": "rock",
          "status": "on", "text": "" }
              ],
              "children": null
            }
          ],
          "children": null
        }
      ]
    };

    // Card dimensions by level
    const CARD_DIMS = {
      corporate: { width: 320, height: 410, radius: 12 },
      office: { width: 280, height: 350, radius: 12 },
      goal: { width: 200, height: 100, radius: 10 },
      rock: { width: 180, height: 65, radius: 8 },
      scorecard: { width: 280, height: 240, radius: 12 }
    };

    const LEVEL_GAP = 60;
    const SIBLING_GAP = 16;

    // Colors by level
    const COLORS = {
      corporate: '#6A45B7',
      office: '#6C63FF',
      goal: '#F28907',
      rock: '#8C74BF',
      scorecard: 'rgb(0, 173, 239)'
    };

    // Create SVG
    const container = d3.select("#tree-container");
    const svg = container.append("svg").attr("id", "tree-svg");

    // Defs
    const defs = svg.append("defs");
    
    const gradient = defs.append("linearGradient")
      .attr("id", "tenYearGradient")
      .attr("x1", "0%").attr("y1", "0%")
      .attr("x2", "100%").attr("y2", "100%");
    gradient.append("stop").attr("offset", "0%").attr("stop-color", "#f7f4ff");
    gradient.append("stop").attr("offset", "100%").attr("stop-color", "#e1ddf5");

    const filter = defs.append("filter")
      .attr("id", "shadow")
      .attr("x", "-20%").attr("y", "-20%")
      .attr("width", "140%").attr("height", "140%");
    filter.append("feDropShadow")
      .attr("dx", "0").attr("dy", "4")
      .attr("stdDeviation", "6")
      .attr("flood-color", "rgba(0,0,0,0.08)");

    const filterHover = defs.append("filter")
      .attr("id", "shadowHover")
      .attr("x", "-20%").attr("y", "-20%")
      .attr("width", "140%").attr("height", "140%");
    filterHover.append("feDropShadow")
      .attr("dx", "0").attr("dy", "6")
      .attr("stdDeviation", "10")
      .attr("flood-color", "rgba(0,0,0,0.12)");

    const linkGroup = svg.append("g").attr("class", "links");
    const nodeGroup = svg.append("g").attr("class", "nodes");

    function truncateText(text, maxLen) {
      if (!text) return "";
      if (text.length <= maxLen) return text;
      return text.substring(0, maxLen - 3) + "...";
    }

    function formatCurrency(value) {
      if (value >= 1000000000) {
        return "$" + (value / 1000000000).toFixed(2) + "B";
      } else if (value >= 1000000) {
        return "$" + (value / 1000000).toFixed(1) + "M";
      } else if (value >= 1000) {
        return "$" + (value / 1000).toFixed(0) + "K";
      }
      return "$" + value;
    }

    // Calculate positions
    function calculatePositions(node) {
      if (!node.children || node.children.length === 0) {
        node.subtreeWidth = CARD_DIMS[node.data.level].width;
        return;
      }

      node.children.forEach(calculatePositions);

      const childWidths = node.children.map(c => c.subtreeWidth);
      const totalChildWidth = d3.sum(childWidths) + (node.children.length - 1) * SIBLING_GAP;
      
      node.subtreeWidth = Math.max(CARD_DIMS[node.data.level].width, totalChildWidth);
    }

    function assignXPositions(node, leftX) {
      const dims = CARD_DIMS[node.data.level];
      
      if (!node.children || node.children.length === 0) {
        node.x = leftX + node.subtreeWidth / 2;
        return;
      }

      const childWidths = node.children.map(c => c.subtreeWidth);
      const totalChildWidth = d3.sum(childWidths) + (node.children.length - 1) * SIBLING_GAP;
      
      let childX = leftX + (node.subtreeWidth - totalChildWidth) / 2;
      
      node.children.forEach((child, i) => {
        assignXPositions(child, childX);
        childX += child.subtreeWidth + SIBLING_GAP;
      });

      const firstChild = node.children[0];
      const lastChild = node.children[node.children.length - 1];
      node.x = (firstChild.x + lastChild.x) / 2;
    }

    function assignYPositions(node, y) {
      const dims = CARD_DIMS[node.data.level];
      node.y = y;
      
      if (node.children) {
        node.children.forEach(child => {
          assignYPositions(child, y + dims.height + LEVEL_GAP);
        });
      }
    }

    function toggleGoals(parentData) {
      if (parentData.children && parentData.children.some(c => c.level === 'goal')) {
        parentData._children = parentData.children.filter(c => c.level === 'goal');
        parentData.children = parentData.children.filter(c => c.level !== 'goal');
        if (parentData.children.length === 0) parentData.children = null;
      } else if (parentData._children) {
        if (!parentData.children) parentData.children = [];
        parentData.children = parentData.children.concat(parentData._children);
        parentData._children = null;
      }
      update();
    }

    function toggleRocks(parentData) {
      if (parentData.children) {
        parentData._children = parentData.children;
        parentData.children = null;
      } else if (parentData._children) {
        parentData.children = parentData._children;
        parentData._children = null;
      }
      update();
    }

    function toggleScorecard(parentData) {
      if (parentData._scorecardNode) {
        if (parentData.children) {
          parentData.children = parentData.children.filter(c => c.level !== 'scorecard');
          if (parentData.children.length === 0) parentData.children = null;
        }
        parentData._scorecardNode = null;
      } else {
        const scorecardNode = {
          id: parentData.id + '-scorecard',
          name: 'Scorecard',
          level: 'scorecard',
          scorecard: parentData.scorecard
        };
        parentData._scorecardNode = scorecardNode;
        if (!parentData.children) parentData.children = [];
        parentData.children.unshift(scorecardNode);
      }
      update();
    }

    function update() {
      const root = d3.hierarchy(visionData);
      
      calculatePositions(root);
      assignXPositions(root, 50);
      assignYPositions(root, 30);

      let maxX = 0, maxY = 0;
      root.each(node => {
        const dims = CARD_DIMS[node.data.level];
        maxX = Math.max(maxX, node.x + dims.width / 2);
        maxY = Math.max(maxY, node.y + dims.height);
      });

      svg.attr("width", maxX + 50).attr("height", maxY + 50);

      const links = [];
      root.each(node => {
        if (!node.children) return;
        
        const dims = CARD_DIMS[node.data.level];
        const parentBottom = node.y + dims.height;
        const childTop = node.children[0].y;
        const midY = parentBottom + (childTop - parentBottom) / 2;

        links.push({ d: `M${node.x},${parentBottom} L${node.x},${midY}` });

        const leftX = node.children[0].x;
        const rightX = node.children[node.children.length - 1].x;
        
        if (leftX !== rightX) {
          links.push({ d: `M${leftX},${midY} L${rightX},${midY}` });
        }

        node.children.forEach(child => {
          links.push({ d: `M${child.x},${midY} L${child.x},${child.y}` });
        });
      });

      linkGroup.selectAll("path").remove();
      linkGroup.selectAll("path")
        .data(links)
        .enter()
        .append("path")
        .attr("class", "link")
        .attr("d", d => d.d);

      nodeGroup.selectAll("g").remove();

      root.each(node => {
        const g = nodeGroup.append("g");

        switch (node.data.level) {
          case 'corporate': drawCorporateCard(g, node); break;
          case 'office': drawOfficeCard(g, node); break;
          case 'goal': drawGoalCard(g, node); break;
          case 'rock': drawRockCard(g, node); break;
          case 'scorecard': drawScorecardCard(g, node); break;
        }
      });
    }

    function drawBadge(g, x, y, label, isActive, color, onClick, activeTextWhite = false, showCaret = false) {
      const badgeWidth = 70;
      const badgeHeight = 22;
      
      const btnG = g.append("g")
        .attr("class", "clickable")
        .on("click", (event) => {
          event.stopPropagation();
          onClick();
        });
      
      btnG.append("rect")
        .attr("x", x - badgeWidth/2).attr("y", y)
        .attr("width", badgeWidth).attr("height", badgeHeight)
        .attr("rx", 11).attr("fill", isActive ? color : "#E8E9EC");
      
      const textColor = isActive && activeTextWhite ? "white" : "#555";

      btnG.append("text")
        .attr("class", "badge-text")
        .attr("x", x - (showCaret ? 8 : 0)).attr("y", y + 14)
        .attr("text-anchor", "middle")
        .attr("fill", textColor)
        .text(label);

      if (showCaret) {
        btnG.append("foreignObject")
          .attr("x", x + badgeWidth/2 - 18)
          .attr("y", y + 4)
          .attr("width", 14)
          .attr("height", 14)
          .append("xhtml:div")
          .style("width", "14px")
          .style("height", "14px")
          .style("display", "flex")
          .style("align-items", "center")
          .style("justify-content", "center")
          .append("i")
          .attr("class", `fal ${isActive ? 'fa-chevron-down' : 'fa-chevron-right'}`)
          .style("font-size", "11px")
          .style("color", textColor);
      }
    }

    function getStatusConfig(status) {
      if (status === 'off') {
        return { color: '#B00020', label: 'Off Track' };
      }
      return { color: '#468847', label: 'On Track' };
    }

    function drawStatusPill(g, x, y, label, color) {
      const pillWidth = 56;
      const pillHeight = 16;
      const pill = g.append("g");

      pill.append("rect")
        .attr("x", x)
        .attr("y", y)
        .attr("width", pillWidth)
        .attr("height", pillHeight)
        .attr("rx", pillHeight / 2)
        .attr("fill", color);

      pill.append("text")
        .attr("class", "status-pill-text")
        .attr("x", x + pillWidth / 2)
        .attr("y", y + pillHeight / 2 + 3)
        .attr("text-anchor", "middle")
        .attr("fill", "white")
        .text(label);
    }

    function drawCardBackground(g, dims, x, y, level) {
      const strokeColor = COLORS[level] || "#E8E9EC";
      const cardX = x - dims.width / 2;
      const cardRadius = dims.radius || 12;

      g.append("rect")
        .attr("x", cardX).attr("y", y)
        .attr("width", dims.width).attr("height", dims.height)
        .attr("rx", cardRadius).attr("fill", "white")
        .attr("stroke", strokeColor).attr("stroke-width", 1)
        .attr("filter", "url(#shadow)");

    }

    function drawCorporateCard(g, node) {
      const dims = CARD_DIMS.corporate;
      const x = node.x;
      const y = node.y;
      const data = node.data;
      const vto = data.vto;
      const padding = 16;
      const hasScorecard = !!data._scorecardNode;

      drawCardBackground(g, dims, x, y, data.level);

      let cy = y + padding;

      g.append("text").attr("class", "node-name")
        .attr("x", x - dims.width/2 + padding).attr("y", cy + 14)
        .text(data.name);
      cy += 28;

      g.append("line").attr("class", "header-line")
        .attr("x1", x - dims.width/2 + padding).attr("x2", x + dims.width/2 - padding)
        .attr("y1", cy).attr("y2", cy);
      cy += 12;

      if (vto.tenYearTarget) {
        g.append("rect")
          .attr("x", x - dims.width/2 + padding).attr("y", cy)
          .attr("width", dims.width - padding*2).attr("height", 40)
          .attr("rx", 4).attr("fill", "url(#tenYearGradient)");
        g.append("text").attr("class", "ten-year-label")
          .attr("x", x).attr("y", cy + 14).attr("text-anchor", "middle")
          .text("10-Year Target");
        g.append("text").attr("class", "ten-year-value")
          .attr("x", x).attr("y", cy + 32).attr("text-anchor", "middle")
          .text(vto.tenYearTarget);
        cy += 48;
      }

      cy = drawPlanSection(g, x, dims.width, cy, padding, "3-Year Picture (2029)", vto.threeYearPicture, true);
      cy += 8;
      drawPlanSection(g, x, dims.width, cy, padding, "1-Year Plan (2026)", vto.oneYearPlan, false);

      drawBadge(g, x, y + dims.height - 32, "Scorecard", hasScorecard, COLORS.scorecard, () => toggleScorecard(data), true, true);
    }

    function drawOfficeCard(g, node) {
      const dims = CARD_DIMS.office;
      const x = node.x;
      const y = node.y;
      const data = node.data;
      const vto = data.vto;
      const padding = 14;
      const hasScorecard = !!data._scorecardNode;
      const hasGoalsExpanded = node.children && node.children.some(c => c.data.level === 'goal');
      const hasGoals = hasGoalsExpanded || !!data._children;

      drawCardBackground(g, dims, x, y, data.level);

      let cy = y + padding;

      g.append("text").attr("class", "node-name")
        .attr("x", x - dims.width/2 + padding).attr("y", cy + 14)
        .text(data.name);
      cy += 26;

      g.append("line").attr("class", "header-line")
        .attr("x1", x - dims.width/2 + padding).attr("x2", x + dims.width/2 - padding)
        .attr("y1", cy).attr("y2", cy);
      cy += 10;

      cy = drawPlanSection(g, x, dims.width, cy, padding, "3-Year Picture", vto.threeYearPicture, true);
      cy += 6;
      drawPlanSection(g, x, dims.width, cy, padding, "1-Year Plan", vto.oneYearPlan, false);

      const badgeY = y + dims.height - 32;
      drawBadge(g, x - 40, badgeY, "Scorecard", hasScorecard, COLORS.scorecard, () => toggleScorecard(data), true, true);
      if (hasGoals) {
        drawBadge(g, x + 40, badgeY, "Goals", hasGoalsExpanded, COLORS.goal, () => toggleGoals(data), true, true);
      }
    }

    function drawPlanSection(g, x, width, cy, padding, title, data, showLookLike) {
      const leftX = x - width/2 + padding;
      const contentWidth = width - padding*2;
      const metricWidth = (contentWidth - 8) / 2;

      g.append("text").attr("class", "section-title")
        .attr("x", leftX).attr("y", cy + 10)
        .text(title);
      cy += 16;

      g.append("rect").attr("class", "metric-bg")
        .attr("x", leftX).attr("y", cy)
        .attr("width", metricWidth).attr("height", 40).attr("rx", 4);
      g.append("text").attr("class", "metric-label")
        .attr("x", leftX + 6).attr("y", cy + 12).text("Revenue");
      g.append("text").attr("class", "metric-value")
        .attr("x", leftX + 6).attr("y", cy + 28).text(data.revenue);

      g.append("rect").attr("class", "metric-bg")
        .attr("x", leftX + metricWidth + 8).attr("y", cy)
        .attr("width", metricWidth).attr("height", 40).attr("rx", 4);
      g.append("text").attr("class", "metric-label")
        .attr("x", leftX + metricWidth + 14).attr("y", cy + 12).text("Profit");
      g.append("text").attr("class", "metric-value")
        .attr("x", leftX + metricWidth + 14).attr("y", cy + 28).text(data.profit);
      cy += 46;

      if (data.measurables) {
        g.append("rect").attr("class", "metric-bg")
          .attr("x", leftX).attr("y", cy)
          .attr("width", contentWidth).attr("height", 26).attr("rx", 3);
        g.append("text").attr("class", "measurables-label")
          .attr("x", leftX + 6).attr("y", cy + 10).text("Measurables");
        g.append("text").attr("class", "measurables-text")
          .attr("x", leftX + 6).attr("y", cy + 20)
          .text(truncateText(data.measurables, 38));
        cy += 30;
      }

      if (showLookLike && data.whatDoesItLookLike && data.whatDoesItLookLike.length > 0) {
        g.append("text").attr("class", "look-like-label")
          .attr("x", leftX).attr("y", cy + 10).text("What Does It Look Like?");
        cy += 14;
        data.whatDoesItLookLike.slice(0, 3).forEach((item, i) => {
          g.append("text").attr("class", "look-like-item")
            .attr("x", leftX + 8).attr("y", cy + i * 12 + 10)
            .text("â€¢ " + truncateText(item, 34));
        });
        cy += Math.min(data.whatDoesItLookLike.length, 3) * 12 + 4;
      }

      return cy;
    }

    function drawGoalCard(g, node) {
      const dims = CARD_DIMS.goal;
      const x = node.x;
      const y = node.y;
      const data = node.data;
      const padding = 12;
      const hasRocksExpanded = !!node.children;
      const hasRocks = hasRocksExpanded || !!data._children;

      drawCardBackground(g, dims, x, y, data.level);

      const statusInfo = getStatusConfig(data.status);
      drawStatusPill(g, x + dims.width/2 - padding - 56, y + padding / 2, statusInfo.label, statusInfo.color);

      const titleY = y + padding + 26;

      g.append("text").attr("class", "goal-title")
        .attr("x", x - dims.width/2 + padding).attr("y", titleY)
        .text(data.name);

      g.append("text").attr("class", "goal-text")
        .attr("x", x - dims.width/2 + padding).attr("y", titleY + 18)
        .text(truncateText(data.text, 28));

      g.append("text").attr("class", "goal-text")
        .attr("x", x - dims.width/2 + padding).attr("y", titleY + 32)
        .text(truncateText(data.text.substring(28), 28));

      if (hasRocks) {
        drawBadge(g, x, y + dims.height - 26, "Rocks", hasRocksExpanded, COLORS.rock, () => toggleRocks(data), true, true);
      }
    }

    function drawRockCard(g, node) {
      const dims = CARD_DIMS.rock;
      const x = node.x;
      const y = node.y;
      const data = node.data;
      const padding = 10;

      drawCardBackground(g, dims, x, y, data.level);

      const statusInfo = getStatusConfig(data.status);
      drawStatusPill(g, x + dims.width/2 - padding - 56, y + 6, statusInfo.label, statusInfo.color);

      const textStartY = y + 26;

      g.append("text").attr("class", "rock-title")
        .attr("x", x - dims.width/2 + padding).attr("y", textStartY)
        .text(data.name);

      g.append("text").attr("class", "rock-text")
        .attr("x", x - dims.width/2 + padding).attr("y", textStartY + 16)
        .text(truncateText(data.text, 26));

      g.append("text").attr("class", "rock-text")
        .attr("x", x - dims.width/2 + padding).attr("y", textStartY + 28)
        .text(truncateText(data.text.substring(26), 26));
    }

    function drawScorecardCard(g, node) {
      const data = node.data;
      const scorecard = data.scorecard;
      const rowHeight = 22;
      const headerHeight = 40;
      const padding = 12;
      const dims = {
        width: CARD_DIMS.scorecard.width,
        height: headerHeight + scorecard.length * rowHeight + padding * 2,
        radius: CARD_DIMS.scorecard.radius
      };
      
      CARD_DIMS.scorecard.height = dims.height;
      
      const x = node.x;
      const y = node.y;

      drawCardBackground(g, dims, x, y, data.level);

      let cy = y + padding;
      const leftX = x - dims.width/2 + padding;
      const contentWidth = dims.width - padding * 2;

      g.append("text").attr("class", "node-name")
        .attr("x", leftX).attr("y", cy + 12)
        .text("Scorecard");
      cy += 24;

      g.append("text").attr("class", "scorecard-header")
        .attr("x", leftX).attr("y", cy + 10)
        .text("Measurable");
      g.append("text").attr("class", "scorecard-header")
        .attr("x", leftX + 120).attr("y", cy + 10)
        .text("Target");
      g.append("text").attr("class", "scorecard-header")
        .attr("x", leftX + 175).attr("y", cy + 10)
        .text("Current");
      cy += 16;

      scorecard.forEach((row, i) => {
        const rowY = cy + i * rowHeight;
        
        g.append("rect")
          .attr("class", i % 2 === 0 ? "scorecard-row-bg" : "scorecard-row-bg-alt")
          .attr("x", leftX - 4).attr("y", rowY)
          .attr("width", contentWidth + 8).attr("height", rowHeight)
          .attr("rx", 2);

        g.append("text").attr("class", "scorecard-name")
          .attr("x", leftX).attr("y", rowY + 15)
          .text(truncateText(row.name, 18));

        g.append("text").attr("class", "scorecard-value")
          .attr("x", leftX + 120).attr("y", rowY + 15)
          .text(formatCurrency(row.target));

        g.append("text").attr("class", "scorecard-value")
          .attr("x", leftX + 175).attr("y", rowY + 15)
          .text(formatCurrency(row.current));

        g.append("circle")
          .attr("cx", leftX + contentWidth - 4)
          .attr("cy", rowY + 11)
          .attr("r", 5)
          .attr("class", row.onTrack ? "on-track" : "off-track");
      });
    }

    update();
  </script>
</body>
</html>
